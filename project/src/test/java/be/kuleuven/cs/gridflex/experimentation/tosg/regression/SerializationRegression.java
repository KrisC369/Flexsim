package be.kuleuven.cs.gridflex.experimentation.tosg.regression;

import be.kuleuven.cs.gridflex.domain.energy.dso.r3dp.FlexAllocProblemContext;
import be.kuleuven.cs.gridflex.domain.energy.dso.r3dp.FlexProvider;
import be.kuleuven.cs.gridflex.domain.energy.dso.r3dp.FlexibilityProvider;
import be.kuleuven.cs.gridflex.domain.energy.dso.r3dp.HourlyFlexConstraints;
import be.kuleuven.cs.gridflex.domain.util.data.TimeSeries;
import be.kuleuven.cs.gridflex.domain.util.data.profiles.CongestionProfile;
import be.kuleuven.cs.gridflex.experimentation.tosg.wgmf.ExperimentParams;
import be.kuleuven.cs.gridflex.experimentation.tosg.wgmf.SerializationUtils;
import be.kuleuven.cs.gridflex.persistence.MapDBMemoizationContext;
import be.kuleuven.cs.gridflex.persistence.MemoizationContext;
import be.kuleuven.cs.gridflex.solvers.memoization.immutableViews.AllocResultsView;
import be.kuleuven.cs.gridflex.solvers.memoization.immutableViews.ImmutableSolverProblemContextView;
import com.google.common.base.Supplier;
import com.google.common.collect.Lists;
import org.junit.Before;
import org.junit.Test;

import java.io.IOException;
import java.util.Base64;
import java.util.Collection;

import static be.kuleuven.cs.gridflex.experimentation.tosg.wgmf.SerializationUtils.unpickle;
import static be.kuleuven.cs.gridflex.experimentation.tosg.wgmf
        .WgmfGameRunnerVariableDistributionCostsTest.getParams;
import static be.kuleuven.cs.gridflex.experimentation.tosg.wgmf
        .WgmfGameRunnerVariableDistributionCostsTest.loadTestResources;
import static org.junit.Assert.assertArrayEquals;
import static org.junit.Assert.assertEquals;

/**
 * @author Kristof Coninx <kristof.coninx AT cs.kuleuven.be>
 */
public class SerializationRegression {
    private static final String DB_NAME = "DB";
    private HourlyFlexConstraints constr;
    private FlexibilityProvider provider1;
    private FlexibilityProvider provider2;
    private CongestionProfile congestionProfile;
    private FlexAllocProblemContext context;
    private Supplier<MemoizationContext<ImmutableSolverProblemContextView, AllocResultsView>>
            memoizationSupplier;
    private String HARDCODED_EXPECTED_CONTEXT_SERIALIZATION =
            "rO0ABXNyAGViZS5rdWxldXZlbi5jcy5mbGV4c2ltLnNvbHZlcnMubWVtb2l6YXRpb24uaW1tdXRhYmxlVmlld3MuQXV0b1ZhbHVlX0ltbXV0YWJsZVNvbHZlclByb2JsZW1Db250ZXh0Vmlld9MSUnNc01ZOAgADSgAJc2VlZFZhbHVlTAAMaW5wdXRQcm9maWxldAAqTGl0L3VuaW1pL2RzaS9mYXN0dXRpbC9kb3VibGVzL0RvdWJsZUxpc3Q7TAAJcHJvdmlkZXJzdAApTGNvbS9nb29nbGUvY29tbW9uL2NvbGxlY3QvSW1tdXRhYmxlTGlzdDt4cgBbYmUua3VsZXV2ZW4uY3MuZmxleHNpbS5zb2x2ZXJzLm1lbW9pemF0aW9uLmltbXV0YWJsZVZpZXdzLkltbXV0YWJsZVNvbHZlclByb2JsZW1Db250ZXh0Vmlld9MSUnNc01ZOAgAAeHAAAAAAAAAAAHNyADppdC51bmltaS5kc2kuZmFzdHV0aWwuZG91Ymxlcy5Eb3VibGVMaXN0cyRVbm1vZGlmaWFibGVMaXN0njd5uX9KfBcCAAFMAARsaXN0cQB+AAF4cgBGaXQudW5pbWkuZHNpLmZhc3R1dGlsLmRvdWJsZXMuRG91YmxlQ29sbGVjdGlvbnMkVW5tb2RpZmlhYmxlQ29sbGVjdGlvbp43ebl/SnwXAgABTAAKY29sbGVjdGlvbnQAMExpdC91bmltaS9kc2kvZmFzdHV0aWwvZG91Ymxlcy9Eb3VibGVDb2xsZWN0aW9uO3hwc3IALWl0LnVuaW1pLmRzaS5mYXN0dXRpbC5kb3VibGVzLkRvdWJsZUFycmF5TGlzdJ43ebl/SnwWAwABSQAEc2l6ZXhwAAACnXoAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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+om5BPMCAAJMACBmbGV4aWJpbGl0eUFjdGl2YXRpb25Db25zdHJhaW50c3QARUxiZS9rdWxldXZlbi9jcy9mbGV4c2ltL2RvbWFpbi9lbmVyZ3kvZHNvL3IzZHAvSG91cmx5RmxleENvbnN0cmFpbnRzO0wAGWZsZXhpYmlsaXR5QWN0aXZhdGlvblJhdGV0AENMYmUva3VsZXV2ZW4vY3MvZmxleHNpbS9kb21haW4vdXRpbC9kYXRhL0RvdWJsZVBvd2VyQ2FwYWJpbGl0eUJhbmQ7eHIAUWJlLmt1bGV1dmVuLmNzLmZsZXhzaW0uc29sdmVycy5tZW1vaXphdGlvbi5pbW11dGFibGVWaWV3cy5GbGV4aWJpbGl0eVByb3ZpZGVyVmlld5URcPqJuQTzAgAAeHBzcgBNYmUua3VsZXV2ZW4uY3MuZmxleHNpbS5kb21haW4uZW5lcmd5LmRzby5yM2RwLkF1dG9WYWx1ZV9Ib3VybHlGbGV4Q29uc3RyYWludHPedmVxCEjMmwIAA0QAEmFjdGl2YXRpb25EdXJhdGlvbkQAE2ludGVyQWN0aXZhdGlvblRpbWVEABJtYXhpbXVtQWN0aXZhdGlvbnN4cgBDYmUua3VsZXV2ZW4uY3MuZmxleHNpbS5kb21haW4uZW5lcmd5LmRzby5yM2RwLkhvdXJseUZsZXhDb25zdHJhaW50c952ZXEISMybAgAAeHA/8AAAAAAAAEAAAAAAAAAAQBAAAAAAAABzcgBLYmUua3VsZXV2ZW4uY3MuZmxleHNpbS5kb21haW4udXRpbC5kYXRhLkF1dG9WYWx1ZV9Eb3VibGVQb3dlckNhcGFiaWxpdHlCYW5kwpeC5MQG3i8CAAJEAARkb3duRAACdXB4cgBBYmUua3VsZXV2ZW4uY3MuZmxleHNpbS5kb21haW4udXRpbC5kYXRhLkRvdWJsZVBvd2VyQ2FwYWJpbGl0eUJhbmTCl4LkxAbeLwIAAHhwAAAAAAAAAABAaQAAAAAAAHNxAH4AEHEAfgAXc3EAfgAYAAAAAAAAAABAiQAAAAAAAA==";

    @Before
    public void setUp() {
        constr = HourlyFlexConstraints.builder().activationDuration(1)
                .interActivationTime(2).maximumActivations(4).build();
        provider1 = new FlexProvider(200, constr);
        provider2 = new FlexProvider(800, constr);
        ExperimentParams params = getParams("DUMMY");
        congestionProfile = loadTestResources(params).getInputData()
                .getCongestionProfile();
        context = new FlexAllocProblemContext() {
            @Override
            public Collection<FlexibilityProvider> getProviders() {
                return Lists.newArrayList(provider1, provider2);
            }

            @Override
            public TimeSeries getEnergyProfileToMinimizeWithFlex() {
                return congestionProfile;
            }
        };
        memoizationSupplier = () -> MapDBMemoizationContext.builder().setFileName(DB_NAME)
                .ensureFileExists()
                .build();
    }

    @Test
    public void testDeserializeContext() throws IOException, ClassNotFoundException {
        byte[] decoded = Base64.getDecoder().decode(HARDCODED_EXPECTED_CONTEXT_SERIALIZATION);
        ImmutableSolverProblemContextView unpickled = unpickle(decoded,
                ImmutableSolverProblemContextView.class);
        assertEquals(ImmutableSolverProblemContextView.from(context), unpickled);
    }

    @Test
    public void testSerializeContext() throws IOException {
        ImmutableSolverProblemContextView contextV = ImmutableSolverProblemContextView
                .from(context);
        byte[] pickled = SerializationUtils.pickle(contextV);
        String pickledAsb64String = Base64.getEncoder().encodeToString(pickled);

        byte[] decoded = Base64.getDecoder().decode(pickledAsb64String);
        assertEquals(HARDCODED_EXPECTED_CONTEXT_SERIALIZATION, pickledAsb64String);
        assertArrayEquals(pickled, decoded);
    }
}
